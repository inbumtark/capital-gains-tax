<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tark's 양도소득세 계산기 (2025년 8월 기준)</title>
    <style>
        /* --- CSS Reset & Base Styles --- */
        :root {
            --primary-color: #00529b;
            --secondary-color: #009879;
            --accent-color: #ffc107;
            --background-color: #f4f7f6;
            --card-background: #ffffff;
            --text-color: #333333;
            --light-text-color: #777777;
            --border-color: #dddddd;
            --error-color: #d32f2f;
            --success-color: #388e3c;
            --table-header-bg: #f8f9fa;
            --simulation-bg: #f8f9fa; /* 시뮬레이션 배경색 변수 추가 */
            --font-family: 'Pretendard', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto,
                'Helvetica Neue', Arial, sans-serif;
            --border-radius: 8px;
            --box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            --transition-speed: 0.3s ease;
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
        html { scroll-behavior: smooth; }
        body {
            font-family: var(--font-family);
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            padding: 1rem;
        }

        /* --- Main Container & Layout --- */
        .container {
            max-width: 800px;
            margin: 0 auto;
            padding: 1rem;
        }
        .main-title {
            text-align: center;
            color: var(--primary-color);
            margin-bottom: 2rem;
            font-size: 2.5rem;
            font-weight: 700;
        }

        /* --- Card UI --- */
        .card {
            background-color: var(--card-background);
            border-radius: var(--border-radius);
            box-shadow: var(--box-shadow);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-bottom: 1.5rem;
            border-bottom: 2px solid var(--border-color);
            padding-bottom: 0.5rem;
        }

        /* --- Form Elements --- */
        .form-group { margin-bottom: 1.5rem; }
        .form-group label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
        }
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .input-wrapper .unit {
            position: absolute;
            right: 1rem;
            color: var(--light-text-color);
            pointer-events: none;
        }
        input[type="text"], input[type="number"], select {
            width: 100%;
            padding: 0.75rem 2.5rem 0.75rem 1rem;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            font-size: 1rem;
            transition: border-color var(--transition-speed), box-shadow var(--transition-speed);
        }
        input[type="text"]:focus, input[type="number"]:focus, select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(0, 82, 155, 0.2);
        }
        .helper-text {
            font-size: 0.875rem;
            color: var(--light-text-color);
            margin-top: 0.5rem;
        }
        .error-message {
            color: var(--error-color);
            font-size: 0.875rem;
            margin-top: 0.25rem;
            display: none;
        }
        input[aria-invalid="true"] {
            border-color: var(--error-color);
        }
        input[aria-invalid="true"] ~ .error-message {
            display: block;
        }

        /* --- Button Styles --- */
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color var(--transition-speed), transform var(--transition-speed);
            text-align: center;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-primary:hover { background-color: #00417a; }
        .btn-secondary { background-color: #6c757d; color: white; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-quick-add {
            background-color: #e9ecef;
            color: var(--text-color);
            margin-left: 0.5rem;
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

        /* --- Toggle Button Group --- */
        .toggle-group { display: flex; gap: 0.5rem; }
        .toggle-btn {
            flex-grow: 1;
            background-color: var(--card-background);
            border: 1px solid var(--border-color);
            color: var(--text-color);
        }
        .toggle-btn[aria-pressed="true"] {
            background-color: var(--secondary-color);
            color: white;
            border-color: var(--secondary-color);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.1);
        }

        /* --- Action Buttons --- */
        .action-buttons { display: flex; justify-content: space-between; gap: 1rem; }
        .action-buttons .btn { flex: 1; }

        /* --- Results Section --- */
        #results-section {
            display: none; /* Initially hidden */
            scroll-margin-top: 1rem; /* For smooth scroll targeting */
        }
        .summary { text-align: center; margin-bottom: 2rem; }
        .summary-main { font-size: 2rem; font-weight: 700; color: var(--primary-color); }
        .summary-sub { font-size: 1.2rem; color: var(--light-text-color); }

        /* --- Tables --- */
        .table-container { overflow-x: auto; }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 2rem;
        }
        th, td {
            padding: 0.75rem 1rem;
            text-align: left;
            border-bottom: 1px solid var(--border-color);
        }
        th { background-color: var(--table-header-bg); font-weight: 600; }
        td:nth-child(1) { font-weight: 500; }
        .text-right { text-align: right; }
        .indent { padding-left: 2rem; }
        .total-row { font-weight: bold; background-color: var(--table-header-bg); }
        .disabled-row { color: var(--light-text-color); text-decoration: line-through; }

        /* --- Applied Rules Log & Spacing --- */
        #applied-rules-log {
            list-style-type: none;
            padding-left: 0;
            margin-bottom: 3rem; /* 로그와 시뮬레이션 사이 간격 추가 */
        }
        #applied-rules-log li {
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }
        .log-badge {
            display: inline-block;
            padding: 0.25rem 0.6rem;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
            margin-right: 0.75rem;
            flex-shrink: 0;
        }
        .badge-info { background-color: #17a2b8; }
        .badge-success { background-color: var(--success-color); }
        .badge-warning { background-color: #ffc107; color: #333; }
        .badge-danger { background-color: var(--error-color); }
        .badge-secondary { background-color: #6c757d; }
        
        /* --- Simulation Block Styling --- */
        .simulation-block {
            background-color: var(--simulation-bg);
            padding: 1.5rem;
            border-radius: var(--border-radius);
            margin-bottom: 2rem;
        }
        .simulation-block .card-title {
            border-bottom: none;
            padding-bottom: 0;
            margin-bottom: 1rem;
        }

        /* --- Disclaimer & User Guide --- */
        .disclaimer, .user-guide {
            font-size: 0.875rem;
            color: var(--light-text-color);
            background-color: #e9ecef;
            padding: 1rem;
            border-radius: var(--border-radius);
        }
        .user-guide h4 { color: var(--text-color); margin-top: 1rem; margin-bottom: 0.5rem; }
        .user-guide h4:first-child { margin-top: 0; }
        .user-guide ul { padding-left: 1.5rem; }

        /* --- Toast Notification --- */
        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background-color: rgba(0, 0, 0, 0.75);
            color: white;
            padding: 1rem 1.5rem;
            border-radius: var(--border-radius);
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.5s, visibility 0.5s;
        }
        #toast.show {
            opacity: 1;
            visibility: visible;
        }

        /* --- Responsive Design --- */
        @media (max-width: 600px) {
            body { padding: 0.5rem; }
            .container { padding: 0.5rem; }
            .card { padding: 1.5rem; }
            .main-title { font-size: 2rem; }
            .card-title { font-size: 1.3rem; }
            .action-buttons { flex-direction: column; }
            .simulation-block { padding: 1rem; }
        }
    </style>
</head>
<body>

    <main class="container">
        <h1 class="main-title">양도소득세 계산기 (2025년 8월 기준)</h1>

        <form id="tax-form" novalidate>
            <section class="card">
                <h2 class="card-title">기본 정보 입력</h2>

                <div class="form-group">
                    <label for="salePrice">1. 양도가액 (주택 전체)</label>
                    <div class="input-wrapper">
                        <input type="text" id="salePrice" inputmode="numeric" required>
                        <span class="unit">원</span>
                    </div>
                    <div>
                        <button type="button" class="btn btn-quick-add" data-field="salePrice" data-amount="500000000">+5억</button>
                        <button type="button" class="btn btn-quick-add" data-field="salePrice" data-amount="100000000">+1억</button>
                        <button type="button" class="btn btn-quick-add" data-field="salePrice" data-amount="10000000">+1천만</button>
                    </div>
                    <p class="helper-text">공동명의 여부와 관계없이 주택 전체 양도 가액을 입력합니다.</p>
                    <div class="error-message" role="alert">필수 입력 항목입니다.</div>
                </div>

                <div class="form-group">
                    <label for="acquisitionPrice">2. 취득가액 (주택 전체)</label>
                    <div class="input-wrapper">
                        <input type="text" id="acquisitionPrice" inputmode="numeric" required>
                        <span class="unit">원</span>
                    </div>
                     <div>
                        <button type="button" class="btn btn-quick-add" data-field="acquisitionPrice" data-amount="500000000">+5억</button>
                        <button type="button" class="btn btn-quick-add" data-field="acquisitionPrice" data-amount="100000000">+1억</button>
                        <button type="button" class="btn btn-quick-add" data-field="acquisitionPrice" data-amount="10000000">+1천만</button>
                    </div>
                    <div class="error-message" role="alert">필수 입력 항목입니다.</div>
                </div>

                <div class="form-group">
                    <label for="expenses">3. 필요경비 및 수수료 (주택 전체)</label>
                    <div class="input-wrapper">
                        <input type="text" id="expenses" inputmode="numeric" required>
                        <span class="unit">원</span>
                    </div>
                     <div>
                        <button type="button" class="btn btn-quick-add" data-field="expenses" data-amount="100000000">+1억</button>
                        <button type="button" class="btn btn-quick-add" data-field="expenses" data-amount="10000000">+1천만</button>
                        <button type="button" class="btn btn-quick-add" data-field="expenses" data-amount="1000000">+1백만</button>
                    </div>
                    <p class="helper-text">취득세, 중개수수료 등 전체 소요 경비 합계액</p>
                    <div class="error-message" role="alert">필수 입력 항목입니다.</div>
                </div>
            </section>

            <section class="card">
                <h2 class="card-title">자산 및 보유 정보</h2>

                <div class="form-group">
                    <label>4. 부동산의 종류</label>
                    <div id="property-type" class="toggle-group" role="radiogroup">
                        <button type="button" class="btn toggle-btn" role="radio" aria-pressed="false" data-value="1_home">1주택</button>
                        <button type="button" class="btn toggle-btn" role="radio" aria-pressed="false" data-value="2_homes">2주택</button>
                        <button type="button" class="btn toggle-btn" role="radio" aria-pressed="false" data-value="3_homes">3+주택</button>
                        <button type="button" class="btn toggle-btn" role="radio" aria-pressed="false" data-value="building">토지/건물</button>
                    </div>
                    <div id="property-type-error" class="error-message" role="alert">필수 선택 항목입니다.</div>
                </div>

                 <div class="form-group">
                    <label for="ownershipShare">5. 본인 지분비율</label>
                    <div class="input-wrapper">
                        <input type="number" id="ownershipShare" step="0.1" min="0.1" max="100" placeholder="100" required>
                        <span class="unit">%</span>
                    </div>
                    <p class="helper-text">단독 명의는 100%, 부부 공동명의(각 1/2)는 50%를 입력합니다.</p>
                    <div class="error-message" role="alert">0 초과 100 이하의 숫자를 입력하세요.</div>
                </div>

                <div class="form-group">
                    <label for="holdingPeriod">6. 보유기간</label>
                    <select id="holdingPeriod" required>
                        <option value="">선택하세요</option>
                        </select>
                    <div class="error-message" role="alert">필수 선택 항목입니다.</div>
                </div>
                
                <div class="form-group" id="residence-period-group">
                    <label for="residencePeriod">7. 거주기간 (실제 거주한 기간)</label>
                    <select id="residencePeriod" required>
                        <option value="">선택하세요</option>
                        </select>
                     <div class="error-message" role="alert">필수 선택 항목입니다.</div>
                </div>
                
                 <div class="form-group">
                    <label>8. 취득 시 소재지 (조정 여부)</label>
                    <div id="adjusted-area" class="toggle-group" role="radiogroup">
                        <button type="button" class="btn toggle-btn" role="radio" aria-pressed="false" data-value="true">조정대상지역</button>
                        <button type="button" class="btn toggle-btn" role="radio" aria-pressed="false" data-value="false">비조정대상지역</button>
                    </div>
                    <div id="adjusted-area-error" class="error-message" role="alert">필수 선택 항목입니다.</div>
                </div>
            </section>
            
            <div class="action-buttons">
                <button type="button" id="reset-btn" class="btn btn-secondary">입력내용 초기화</button>
                <button type="submit" id="calculate-btn" class="btn btn-primary">계산하기</button>
            </div>
        </form>

        <section id="results-section" class="card" tabindex="-1">
            <h2 class="card-title">계산 결과</h2>
            
            <div class="summary">
                <div class="summary-main" id="final-tax-user"></div>
                <div class="summary-sub" id="final-tax-total"></div>
            </div>

            <h3 class="card-title">상세 계산 내역 (본인 지분 기준)</h3>
            <div class="table-container">
                <table id="main-results-table">
                    </table>
            </div>

            <h3 class="card-title">적용 규정 로그</h3>
            <ul id="applied-rules-log">
                </ul>

            <div class="simulation-block">
                <h3 class="card-title">시뮬레이션 A: 보유/거주 기간 증가</h3>
                <div class="table-container">
                    <table id="simulation-table-A">
                        </table>
                </div>
            </div>

            <div class="simulation-block">
                <h3 class="card-title">시뮬레이션 B: 양도가액 및 보유/거주 기간 증가</h3>
                <div class="table-container">
                    <table id="simulation-table-B">
                         </table>
                </div>
            </div>
            
            <p class="disclaimer">
                <strong>면책 고지:</strong> 본 계산기는 참고용이며, 실제 신고·납부는 최신 법령·해석 및 개인별 사실관계에 따라 달라질 수 있습니다. 정확한 세액은 반드시 세무 전문가와 상담하시기 바랍니다.
            </p>
        </section>
        
        <section class="user-guide card">
            <h4>사용자 가이드</h4>
            <ul>
                <li><strong>금액 입력:</strong> 모든 금액은 공동명의 여부와 관계없이 '주택 전체' 가액을 기준으로 입력합니다.</li>
                <li><strong>지분비율:</strong> 공동명의인 경우, 세금을 계산할 '본인'의 지분율만 입력하세요. 계산기는 이 지분율을 기준으로 본인의 세금을 계산하고, 이를 통해 전체 총 세액을 추정합니다.</li>
                <li><strong>부동산 종류:</strong> 양도하는 부동산의 종류와 현재 보유 주택 수를 기준으로 선택하세요. 1세대 1주택 비과세, 다주택자 중과 여부 등을 판단하는 중요한 기준이 됩니다.</li>
                <li><strong>조정대상지역:</strong> 양도하는 주택의 '취득 당시' 조정대상지역 여부를 선택하세요. 이는 장기보유특별공제 및 중과세율 적용에 영향을 줄 수 있습니다. (2025년 8월 기준, 대부분 지역이 해제되었으나 과거 취득 시점 기준이므로 확인이 필요합니다.)</li>
            </ul>
        </section>

    </main>

    <div id="toast"></div>

    <script>
    /**
     * @file 전문가급 양도소득세 계산기
     * @author Gemini (Google AI)
     * @version 1.3.0
     * @date 2025-08-10 (기준일)
     *
     * @description
     * 이 파일은 2025년 8월 10일 기준 대한민국 세법을 반영한 양도소득세 계산기입니다.
     * v1.3.0: 로그 중복 제거, 시뮬레이션 UI 개선 (배경색, 간격 조정)
     * v1.2.0: 시뮬레이션 기간 10년으로 확장
     * v1.1.0: 계산 로직 '본인 지분' 기준 변경, 본인/전체 세액 구분 표시
     *
     * --- 법적 근거 및 출처 ---
     * 1. 소득세법 (법률 제19893호, 2023. 12. 31. 일부개정)
     * 2. 국세청 양도소득세 종합안내
     */

    document.addEventListener('DOMContentLoaded', () => {

        const TAX_CONSTANTS = {
            REFERENCE_DATE: '2025-08-10',
            TAX_BRACKETS: [
                { limit: 14000000, rate: 0.06, deduction: 0 }, { limit: 50000000, rate: 0.15, deduction: 1260000 },
                { limit: 88000000, rate: 0.24, deduction: 5760000 }, { limit: 150000000, rate: 0.35, deduction: 15440000 },
                { limit: 300000000, rate: 0.38, deduction: 19940000 }, { limit: 500000000, rate: 0.40, deduction: 25940000 },
                { limit: 1000000000, rate: 0.42, deduction: 35940000 }, { limit: Infinity, rate: 0.45, deduction: 65940000 },
            ],
            ONE_HOME_EXEMPTION: { HIGH_PRICE_THRESHOLD: 1200000000, MIN_HOLDING_YEARS: 2, MIN_RESIDENCE_YEARS_ADJUSTED: 2, },
            LTTD_RATES: {
                ONE_HOME: { HOLDING_RATE_PER_YEAR: 0.04, RESIDENCE_RATE_PER_YEAR: 0.04, MIN_YEARS: 3, MAX_YEARS: 10, MAX_RATE: 0.80, },
                OTHER: [
                    { years: 3, rate: 0.06 }, { years: 4, rate: 0.08 }, { years: 5, rate: 0.10 }, { years: 6, rate: 0.12 },
                    { years: 7, rate: 0.14 }, { years: 8, rate: 0.16 }, { years: 9, rate: 0.18 }, { years: 10, rate: 0.20 },
                    { years: 11, rate: 0.22 }, { years: 12, rate: 0.24 }, { years: 13, rate: 0.26 }, { years: 14, rate: 0.28 }, { years: 15, rate: 0.30 },
                ]
            },
            MULTI_HOME_SURTAX: { IS_SUSPENDED: true }, BASIC_DEDUCTION: 2500000, LOCAL_INCOME_TAX_RATE: 0.10, MAX_AMOUNT: 10000000000000,
        };

        const ui = {
            form: document.getElementById('tax-form'),
            inputs: {
                salePrice: document.getElementById('salePrice'), acquisitionPrice: document.getElementById('acquisitionPrice'),
                expenses: document.getElementById('expenses'), ownershipShare: document.getElementById('ownershipShare'),
                holdingPeriod: document.getElementById('holdingPeriod'), residencePeriod: document.getElementById('residencePeriod'),
            },
            toggleGroups: { propertyType: document.getElementById('property-type'), adjustedArea: document.getElementById('adjusted-area'), },
            buttons: { calculate: document.getElementById('calculate-btn'), reset: document.getElementById('reset-btn'), quickAdd: document.querySelectorAll('.btn-quick-add'), },
            results: {
                section: document.getElementById('results-section'), finalTaxUser: document.getElementById('final-tax-user'),
                finalTaxTotal: document.getElementById('final-tax-total'), mainTable: document.getElementById('main-results-table'),
                appliedRulesLog: document.getElementById('applied-rules-log'), simTableA: document.getElementById('simulation-table-A'),
                simTableB: document.getElementById('simulation-table-B'),
            },
            residencePeriodGroup: document.getElementById('residence-period-group'), toast: document.getElementById('toast'),
        };

        const utils = {
            sanitizeMoney: (v) => parseInt(String(v).replace(/[^\d]/g, '')) || 0,
            formatMoney: (n) => n.toLocaleString('ko-KR'),
            cap: (v, max = TAX_CONSTANTS.MAX_AMOUNT) => Math.min(v, max),
            nonNegativeFloor: (n) => Math.max(0, Math.round(n)),
            getTaxBracket: (taxBase) => TAX_CONSTANTS.TAX_BRACKETS.find(b => taxBase <= b.limit),
            showToast: (message) => {
                ui.toast.textContent = message; ui.toast.classList.add('show');
                setTimeout(() => { ui.toast.classList.remove('show'); }, 3000);
            },
        };
        
        const calculator = {
            isOneHomeExempt: (inputs, totalSalePrice) => {
                const { propertyType, holdingPeriod, residencePeriod, isAdjustedArea } = inputs;
                const rules = TAX_CONSTANTS.ONE_HOME_EXEMPTION;
                const logs = [];
                if (propertyType !== '1_home') return { isExempt: false, logs };

                logs.push({ type: 'info', text: '1주택자 비과세 요건 검토 시작.' });
                
                if (holdingPeriod < rules.MIN_HOLDING_YEARS) {
                     logs.push({ type: 'secondary', text: `비과세 배제: 최소 보유기간 ${rules.MIN_HOLDING_YEARS}년 미충족 (보유 ${holdingPeriod}년).` });
                    return { isExempt: false, logs };
                }
                
                if (isAdjustedArea && residencePeriod < rules.MIN_RESIDENCE_YEARS_ADJUSTED) {
                    logs.push({ type: 'secondary', text: `비과세 배제: 조정대상지역 내 취득 주택 최소 거주기간 ${rules.MIN_RESIDENCE_YEARS_ADJUSTED}년 미충족 (거주 ${residencePeriod}년).` });
                    return { isExempt: false, logs };
                }

                if (totalSalePrice <= rules.HIGH_PRICE_THRESHOLD) {
                    logs.push({ type: 'success', text: `비과세 적용: 1세대 1주택 비과세 요건 충족 (전체 양도가액 ${utils.formatMoney(rules.HIGH_PRICE_THRESHOLD)}원 이하).` });
                    return { isExempt: true, isFullyExempt: true, logs };
                } else {
                    logs.push({ type: 'info', text: `고가주택 판정: 전체 양도가액이 ${utils.formatMoney(rules.HIGH_PRICE_THRESHOLD)}원을 초과하여 초과분에 대해 과세됩니다.` });
                    return { isExempt: true, isFullyExempt: false, logs };
                }
            },
            
            getTaxableGain: (capitalGain, totalSalePrice, exemptionInfo) => {
                const logs = [];
                if (!exemptionInfo.isExempt) {
                    logs.push({ type: 'info', text: '비과세/감면 미적용, 지분 양도차익 전체 과세 대상.' });
                    return { taxableGain: capitalGain, logs };
                }
                if (exemptionInfo.isFullyExempt) return { taxableGain: 0, logs };
                
                const taxablePortion = (totalSalePrice - TAX_CONSTANTS.ONE_HOME_EXEMPTION.HIGH_PRICE_THRESHOLD) / totalSalePrice;
                const taxableGain = capitalGain * taxablePortion;
                logs.push({ type: 'info', text: `고가주택 양도차익 계산 (지분 기준): ${utils.formatMoney(Math.round(taxableGain))}원` });
                return { taxableGain, logs };
            },
            
            getLTTDDeduction: (taxableGain, inputs, isOneHome) => {
                const { holdingPeriod, residencePeriod } = inputs;
                const logs = [];
                let deductionRate = 0;
                let reason = '';

                if (isOneHome) {
                    const rules = TAX_CONSTANTS.LTTD_RATES.ONE_HOME;
                    if (holdingPeriod >= rules.MIN_YEARS) {
                        const holdingYears = Math.min(holdingPeriod, rules.MAX_YEARS);
                        const residenceYears = Math.min(residencePeriod, rules.MAX_YEARS);
                        const holdingDeduction = holdingYears * rules.HOLDING_RATE_PER_YEAR;
                        const residenceDeduction = residenceYears * rules.RESIDENCE_RATE_PER_YEAR;
                        deductionRate = Math.min(holdingDeduction + residenceDeduction, rules.MAX_RATE);
                        reason = `1세대 1주택 장특공 적용: 보유 ${holdingYears}년 (${(holdingDeduction*100).toFixed(0)}%) + 거주 ${residenceYears}년 (${(residenceDeduction*100).toFixed(0)}%) = ${(deductionRate*100).toFixed(0)}%`;
                    }
                } else if (holdingPeriod >= 3) {
                    const applicableRate = TAX_CONSTANTS.LTTD_RATES.OTHER.slice().reverse().find(r => holdingPeriod >= r.years);
                    if(applicableRate) {
                        deductionRate = applicableRate.rate;
                        reason = `일반 장특공 적용: 보유 ${holdingPeriod}년, 공제율 ${(deductionRate*100).toFixed(0)}%.`;
                    }
                }
                
                const deductionAmount = taxableGain * deductionRate;
                if (deductionAmount > 0) logs.push({ type: 'info', text: reason });
                return { deductionAmount, logs };
            },

            runFullCalculation: (inputsForShare, totalSalePrice) => {
                let logs = [];
                const capitalGain = utils.nonNegativeFloor(inputsForShare.salePrice - inputsForShare.acquisitionPrice - inputsForShare.expenses);
                
                const exemptionResult = calculator.isOneHomeExempt(inputsForShare, totalSalePrice);
                logs.push(...exemptionResult.logs);
                
                const taxableGainResult = calculator.getTaxableGain(capitalGain, totalSalePrice, exemptionResult);
                logs.push(...taxableGainResult.logs);
                const taxableGain = taxableGainResult.taxableGain;

                const lttdResult = calculator.getLTTDDeduction(taxableGain, inputsForShare, exemptionResult.isExempt);
                logs.push(...lttdResult.logs);
                const lttdAmount = lttdResult.deductionAmount;

                const capitalIncome = utils.nonNegativeFloor(taxableGain - lttdAmount);
                const basicDeduction = capitalIncome > 0 ? TAX_CONSTANTS.BASIC_DEDUCTION : 0;
                if (basicDeduction > 0) logs.push({type: 'info', text: `기본공제 ${utils.formatMoney(basicDeduction)}원 적용.`});
                
                const taxBase = utils.nonNegativeFloor(capitalIncome - basicDeduction);
                const bracket = utils.getTaxBracket(taxBase);
                const calculatedTax = taxBase * bracket.rate - bracket.deduction;
                if (taxBase > 0) logs.push({type: 'info', text: `세율 ${bracket.rate * 100}% (과표 ${utils.formatMoney(taxBase)}원), 누진공제 ${utils.formatMoney(bracket.deduction)}원 적용.`});

                const localIncomeTax = calculatedTax * TAX_CONSTANTS.LOCAL_INCOME_TAX_RATE;
                if (localIncomeTax > 0) logs.push({type: 'info', text: `지방소득세 (산출세액의 10%) ${utils.formatMoney(utils.nonNegativeFloor(localIncomeTax))}원 가산.`});
                
                const totalTaxForShare = utils.nonNegativeFloor(calculatedTax + localIncomeTax);
                
                return {
                    salePrice: inputsForShare.salePrice, acquisitionPrice: inputsForShare.acquisitionPrice, expenses: inputsForShare.expenses,
                    capitalGain, taxableGain, lttdAmount, capitalIncome, basicDeduction, taxBase,
                    calculatedTax: utils.nonNegativeFloor(calculatedTax), localIncomeTax: utils.nonNegativeFloor(localIncomeTax),
                    totalTax: totalTaxForShare, logs
                };
            },

            getFinalTaxReport: (baseInputs) => {
                // 본인 지분 세액 및 로그 계산
                const userInputs = { ...baseInputs,
                    salePrice: baseInputs.salePrice * (baseInputs.ownershipShare / 100),
                    acquisitionPrice: baseInputs.acquisitionPrice * (baseInputs.ownershipShare / 100),
                    expenses: baseInputs.expenses * (baseInputs.ownershipShare / 100),
                };
                const userResult = calculator.runFullCalculation(userInputs, baseInputs.salePrice);
                
                // 나머지 지분 세액 계산 (로그 불필요)
                let taxForOther = 0;
                const otherShareRatio = 1 - (baseInputs.ownershipShare / 100);
                if (otherShareRatio > 0) {
                    const otherInputs = { ...baseInputs,
                        salePrice: baseInputs.salePrice * otherShareRatio,
                        acquisitionPrice: baseInputs.acquisitionPrice * otherShareRatio,
                        expenses: baseInputs.expenses * otherShareRatio,
                    };
                    // 간소화된 계산 함수 호출 (로그 수집 안함)
                    const otherResult = calculator.runFullCalculation(otherInputs, baseInputs.salePrice);
                    taxForOther = otherResult.totalTax;
                }
                
                const finalTotalTax = userResult.totalTax + taxForOther;
                return { userResult, finalTotalTax };
            }
        };

        const renderer = {
            updateMoneyInput: (el, value) => { el.value = value > 0 ? utils.formatMoney(value) : ''; },
            renderMainTable: (result, finalTotalTax) => {
                const { salePrice, acquisitionPrice, expenses, capitalGain, taxableGain, lttdAmount, capitalIncome, basicDeduction, taxBase, calculatedTax, localIncomeTax, totalTax } = result;
                const isExempt = totalTax === 0 && capitalGain > 0;
                ui.results.mainTable.innerHTML = `
                    <tbody>
                        <tr><td>양도가액 (지분)</td><td class="text-right">${utils.formatMoney(salePrice)} 원</td></tr>
                        <tr><td class="indent">(-) 취득가액 (지분)</td><td class="text-right">${utils.formatMoney(acquisitionPrice)} 원</td></tr>
                        <tr><td class="indent">(-) 필요경비 (지분)</td><td class="text-right">${utils.formatMoney(expenses)} 원</td></tr>
                        <tr class="total-row"><td>양도차익 (지분)</td><td class="text-right">${utils.formatMoney(capitalGain)} 원</td></tr>
                        <tr class="${isExempt ? 'disabled-row' : ''}"><td>과세대상 양도차익</td><td class="text-right">${utils.formatMoney(taxableGain)} 원</td></tr>
                        <tr class="${isExempt ? 'disabled-row' : ''}"><td class="indent">(-) 장기보유특별공제</td><td class="text-right">${utils.formatMoney(lttdAmount)} 원</td></tr>
                        <tr class="total-row ${isExempt ? 'disabled-row' : ''}"><td>양도소득금액</td><td class="text-right">${utils.formatMoney(capitalIncome)} 원</td></tr>
                        <tr class="${isExempt ? 'disabled-row' : ''}"><td class="indent">(-) 기본공제</td><td class="text-right">${utils.formatMoney(basicDeduction)} 원</td></tr>
                        <tr class="total-row ${isExempt ? 'disabled-row' : ''}"><td>과세표준</td><td class="text-right">${utils.formatMoney(taxBase)} 원</td></tr>
                        <tr class="${isExempt ? 'disabled-row' : ''}"><td>산출세액</td><td class="text-right">${utils.formatMoney(calculatedTax)} 원</td></tr>
                        <tr class="${isExempt ? 'disabled-row' : ''}"><td class="indent">(+) 지방소득세</td><td class="text-right">${utils.formatMoney(localIncomeTax)} 원</td></tr>
                        <tr class="total-row"><td><strong>최종 합계 (본인 지분)</strong></td><td class="text-right"><strong>${utils.formatMoney(totalTax)} 원</strong></td></tr>
                        <tr class="total-row"><td><strong>예상 총 세액 (전체 지분)</strong></td><td class="text-right"><strong>${utils.formatMoney(finalTotalTax)} 원</strong></td></tr>
                    </tbody>`;
            },
            renderAppliedRules: (logs) => {
                ui.results.appliedRulesLog.innerHTML = logs.map(log => `<li><span class="log-badge badge-${log.type}">${log.type.toUpperCase()}</span> ${log.text}</li>`).join('');
            },
            renderSimulations: (baseInputs) => {
                let simA_HTML = `<thead><tr><th>보유/거주</th><th>과세표준(본인)</th><th>본인 세액</th><th>총 세액</th><th>주요 변동</th></tr></thead><tbody>`;
                for (let i = 0; i < 10; i++) {
                    const simInputs = { ...baseInputs, holdingPeriod: baseInputs.holdingPeriod + i, residencePeriod: baseInputs.residencePeriod + i };
                    const { userResult, finalTotalTax } = calculator.getFinalTaxReport(simInputs);
                    simA_HTML += `<tr ${i===0 ? 'class="total-row"' : ''}>
                            <td>${simInputs.holdingPeriod}년/${simInputs.residencePeriod}년</td>
                            <td class="text-right">${utils.formatMoney(userResult.taxBase)}</td>
                            <td class="text-right">${utils.formatMoney(userResult.totalTax)}</td>
                            <td class="text-right">${utils.formatMoney(finalTotalTax)}</td>
                            <td>${i === 0 ? "기준" : "기간 증가"}</td></tr>`;
                }
                ui.results.simTableA.innerHTML = simA_HTML + '</tbody>';

                let simB_HTML = `<thead><tr><th>양도가액(전체)</th><th>보유/거주</th><th>본인 세액</th><th>총 세액</th><th>주요 변동</th></tr></thead><tbody>`;
                 for (let i = 0; i < 10; i++) {
                    const simInputs = { ...baseInputs, salePrice: baseInputs.salePrice + (i * 100000000), holdingPeriod: baseInputs.holdingPeriod + i, residencePeriod: baseInputs.residencePeriod + i };
                    const { userResult, finalTotalTax } = calculator.getFinalTaxReport(simInputs);
                    simB_HTML += `<tr ${i===0 ? 'class="total-row"' : ''}>
                            <td class="text-right">${utils.formatMoney(simInputs.salePrice)}</td>
                            <td>${simInputs.holdingPeriod}년/${simInputs.residencePeriod}년</td>
                            <td class="text-right">${utils.formatMoney(userResult.totalTax)}</td>
                            <td class="text-right">${utils.formatMoney(finalTotalTax)}</td>
                            <td>${i === 0 ? "기준" : "가액/기간 증가"}</td></tr>`;
                }
                ui.results.simTableB.innerHTML = simB_HTML + '</tbody>';
            },
            renderAllResults: (report, baseInputs) => {
                const { userResult, finalTotalTax } = report;
                ui.results.finalTaxUser.textContent = `예상 세액 (본인 지분): ₩${utils.formatMoney(userResult.totalTax)}`;
                ui.results.finalTaxTotal.textContent = `(예상 총 세액: ₩${utils.formatMoney(finalTotalTax)})`;
                renderer.renderMainTable(userResult, finalTotalTax);
                renderer.renderAppliedRules(userResult.logs);
                renderer.renderSimulations(baseInputs);
                ui.results.section.style.display = 'block';
                ui.results.section.focus();
                ui.results.section.scrollIntoView();
            }
        };

        const handlers = {
            handleMoneyInput: (e) => {
                const input = e.target;
                renderer.updateMoneyInput(input, utils.cap(utils.sanitizeMoney(input.value)));
            },
            handleQuickAdd: (e) => {
                const btn = e.target, input = document.getElementById(btn.dataset.field);
                const newValue = utils.cap(utils.sanitizeMoney(input.value) + parseInt(btn.dataset.amount));
                if (newValue >= TAX_CONSTANTS.MAX_AMOUNT) utils.showToast("입력 가능한 최대 금액에 도달했습니다.");
                renderer.updateMoneyInput(input, newValue);
            },
            handleToggle: (e) => {
                const button = e.target.closest('.toggle-btn');
                if (!button) return;
                const group = button.parentElement;
                group.querySelectorAll('.toggle-btn').forEach(btn => btn.setAttribute('aria-pressed', 'false'));
                button.setAttribute('aria-pressed', 'true');
                if (group.id === 'property-type') {
                    const isBuilding = handlers.getSelectedToggleValue(group) === 'building';
                    ui.residencePeriodGroup.style.display = isBuilding ? 'none' : 'block';
                    ui.inputs.residencePeriod.required = !isBuilding;
                }
            },
            getSelectedToggleValue: (group) => group.querySelector('[aria-pressed="true"]')?.dataset.value || null,
            validateInput: (input) => {
                let isValid = input.checkValidity();
                if (input.id === 'ownershipShare') { const v = parseFloat(input.value); if (isNaN(v) || v <= 0 || v > 100) isValid = false; }
                const errDiv = input.closest('.form-group').querySelector('.error-message');
                input.setAttribute('aria-invalid', String(!isValid));
                if (errDiv) errDiv.style.display = isValid ? 'none' : 'block';
                return isValid;
            },
            validateToggleGroup: (group) => {
                const isValid = !!handlers.getSelectedToggleValue(group);
                const errDiv = group.closest('.form-group').querySelector('.error-message');
                if (errDiv) errDiv.style.display = isValid ? 'none' : 'block';
                return isValid;
            },
            validateForm: () => {
                let firstInvalidField = null;
                const fields = [...Object.values(ui.inputs), ...Object.values(ui.toggleGroups)];
                const isValid = fields.every(field => {
                    if (field.id === 'residencePeriod' && !field.required) return true;
                    let valid = field.nodeName === 'DIV' ? handlers.validateToggleGroup(field) : handlers.validateInput(field);
                    if (!valid && !firstInvalidField) firstInvalidField = field;
                    return valid;
                });
                if (firstInvalidField) firstInvalidField.focus();
                return isValid;
            },
            handleSubmit: (e) => {
                e.preventDefault();
                if (!handlers.validateForm()) { utils.showToast("일부 입력 항목을 확인해주세요."); return; }
                
                const baseInputs = {
                    salePrice: utils.sanitizeMoney(ui.inputs.salePrice.value), acquisitionPrice: utils.sanitizeMoney(ui.inputs.acquisitionPrice.value),
                    expenses: utils.sanitizeMoney(ui.inputs.expenses.value), propertyType: handlers.getSelectedToggleValue(ui.toggleGroups.propertyType),
                    ownershipShare: parseFloat(ui.inputs.ownershipShare.value), holdingPeriod: parseInt(ui.inputs.holdingPeriod.value),
                    residencePeriod: parseInt(ui.inputs.residencePeriod.value) || 0, isAdjustedArea: handlers.getSelectedToggleValue(ui.toggleGroups.adjustedArea) === 'true',
                };
                
                if(baseInputs.salePrice <= baseInputs.acquisitionPrice + baseInputs.expenses) utils.showToast("양도차익이 없어 세금이 부과되지 않습니다.");

                const report = calculator.getFinalTaxReport(baseInputs);
                renderer.renderAllResults(report, baseInputs);
            },
            handleReset: () => {
                ui.form.reset();
                document.querySelectorAll('[aria-invalid]').forEach(el => el.setAttribute('aria-invalid', 'false'));
                document.querySelectorAll('.error-message').forEach(el => el.style.display = 'none');
                document.querySelectorAll('.toggle-btn').forEach(btn => btn.setAttribute('aria-pressed', 'false'));
                ui.results.section.style.display = 'none';
                window.scrollTo(0, 0);
                ui.inputs.salePrice.focus();
            },
            init: () => {
                for (let i = 1; i <= 15; i++) {
                    ui.inputs.holdingPeriod.add(new Option(`${i}년`, i));
                    ui.inputs.residencePeriod.add(new Option(`${i}년`, i));
                }
                ui.form.addEventListener('submit', handlers.handleSubmit);
                ui.buttons.reset.addEventListener('click', handlers.handleReset);
                [ui.inputs.salePrice, ui.inputs.acquisitionPrice, ui.inputs.expenses].forEach(input => input.addEventListener('input', handlers.handleMoneyInput));
                ui.buttons.quickAdd.forEach(btn => btn.addEventListener('click', handlers.handleQuickAdd));
                Object.values(ui.toggleGroups).forEach(group => group.addEventListener('click', handlers.handleToggle));
            }
        };

        handlers.init();
    });
    </script>
</body>

</html>
